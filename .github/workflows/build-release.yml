name: Build and Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'
      changelog:
        description: 'Changelog (use | for multiple lines)'
        required: false
        type: string
        default: ''

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Get dependencies
        run: flutter pub get

      - name: Build APK
        run: flutter build apk --release

      - name: Rename APK
        run: mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/lan_clip_android.apk

      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/app/outputs/flutter-apk/lan_clip_android.apk

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Get dependencies
        run: flutter pub get

      - name: Build Windows
        run: flutter build windows --release

      - name: Create ZIP
        run: Compress-Archive -Path build/windows/x64/runner/Release/* -DestinationPath lan_clip_windows.zip

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-zip
          path: lan_clip_windows.zip

  release:
    name: Create Release
    needs: [build-android, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Download Android artifact
        uses: actions/download-artifact@v4
        with:
          name: android-apk
          path: artifacts

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-zip
          path: artifacts

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: LAN Clip ${{ github.event.inputs.version }}
          body: |
            ## LAN Clip ${{ github.event.inputs.version }}
            
            ### 更新内容
            ${{ github.event.inputs.changelog || '- 常规更新' }}
            
            ---
            
            ### 下载说明
            - **Android 手机**: 下载 `lan_clip_android.apk` 安装
            - **Windows 电脑**: 下载 `lan_clip_windows.zip` 解压后运行 `lan_clip.exe`
            
            ### 使用方法
            1. 确保手机和电脑在同一局域网
            2. 电脑端打开软件，会自动启动服务
            3. 手机端打开软件，点击搜索发现电脑
            4. 在手机端输入内容，点击发送
            5. 电脑端自动接收并复制到剪切板
          files: |
            artifacts/lan_clip_android.apk
            artifacts/lan_clip_windows.zip
          draft: false
          prerelease: false
