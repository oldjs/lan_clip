name: Build and Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'
      changelog:
        description: 'Changelog (one item per line, e.g.: Fix bug\nAdd feature)'
        required: false
        type: string
        default: ''

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Get dependencies
        run: flutter pub get

      - name: Generate icons
        run: dart run flutter_launcher_icons

      - name: Parse version
        id: parse_version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          # 去掉 v 前缀
          VERSION_NAME="${VERSION#v}"
          # 解析 major.minor.patch 计算 versionCode
          # 格式: major*10000 + minor*100 + patch，确保版本号递增
          MAJOR=$(echo "$VERSION_NAME" | cut -d. -f1)
          MINOR=$(echo "$VERSION_NAME" | cut -d. -f2)
          PATCH=$(echo "$VERSION_NAME" | cut -d. -f3)
          # 默认值处理
          MAJOR=${MAJOR:-0}
          MINOR=${MINOR:-0}
          PATCH=${PATCH:-0}
          BUILD_NUMBER=$((MAJOR * 10000 + MINOR * 100 + PATCH))
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "Calculated: $VERSION_NAME -> versionCode $BUILD_NUMBER"

      - name: Build APK
        run: flutter build apk --release --build-name=${{ steps.parse_version.outputs.version_name }} --build-number=${{ steps.parse_version.outputs.build_number }}

      - name: Rename APK
        run: mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/lan_clip_android.apk

      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/app/outputs/flutter-apk/lan_clip_android.apk

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Get dependencies
        run: flutter pub get

      - name: Generate icons
        run: dart run flutter_launcher_icons

      - name: Parse version
        id: parse_version
        shell: pwsh
        run: |
          $VERSION = "${{ github.event.inputs.version }}"
          # 去掉 v 前缀
          $VERSION_NAME = $VERSION -replace '^v', ''
          # 解析 major.minor.patch 计算 versionCode
          # 格式: major*10000 + minor*100 + patch，确保版本号递增
          $parts = $VERSION_NAME -split '\.'
          $MAJOR = if ($parts.Length -gt 0) { [int]$parts[0] } else { 0 }
          $MINOR = if ($parts.Length -gt 1) { [int]$parts[1] } else { 0 }
          $PATCH = if ($parts.Length -gt 2) { [int]$parts[2] } else { 0 }
          $BUILD_NUMBER = $MAJOR * 10000 + $MINOR * 100 + $PATCH
          echo "version_name=$VERSION_NAME" >> $env:GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $env:GITHUB_OUTPUT
          echo "Calculated: $VERSION_NAME -> versionCode $BUILD_NUMBER"

      - name: Build Windows
        run: flutter build windows --release --build-name=${{ steps.parse_version.outputs.version_name }} --build-number=${{ steps.parse_version.outputs.build_number }}

      - name: Create ZIP
        run: Compress-Archive -Path build/windows/x64/runner/Release/* -DestinationPath lan_clip_windows.zip

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-zip
          path: lan_clip_windows.zip

  release:
    name: Create Release
    needs: [build-android, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Download Android artifact
        uses: actions/download-artifact@v4
        with:
          name: android-apk
          path: artifacts

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-zip
          path: artifacts

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Format changelog
        id: changelog
        run: |
          CHANGELOG="${{ github.event.inputs.changelog }}"
          if [ -z "$CHANGELOG" ]; then
            # 无输入时使用默认值
            echo "formatted=- 常规更新" >> $GITHUB_OUTPUT
          else
            # 将 | 替换为换行，并给每行添加 - 前缀
            FORMATTED=$(echo "$CHANGELOG" | tr '|' '\n' | sed 's/^/- /' | sed '/^- $/d')
            # 使用 EOF 处理多行输出
            echo "formatted<<EOF" >> $GITHUB_OUTPUT
            echo "$FORMATTED" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: LAN Clip ${{ github.event.inputs.version }}
          body: |
            ## LAN Clip ${{ github.event.inputs.version }}
            
            ### 更新内容
            ${{ steps.changelog.outputs.formatted }}
            
            ---
            
            ### 下载说明
            - **Android 手机**: 下载 `lan_clip_android.apk` 安装
            - **Windows 电脑**: 下载 `lan_clip_windows.zip` 解压后运行 `lan_clip.exe`
            
            ### 使用方法
            1. 确保手机和电脑在同一局域网
            2. 电脑端打开软件，会自动启动服务
            3. 手机端打开软件，点击搜索发现电脑
            4. 在手机端输入内容，点击发送
            5. 电脑端自动接收并复制到剪切板
          files: |
            artifacts/lan_clip_android.apk
            artifacts/lan_clip_windows.zip
          draft: false
          prerelease: false
